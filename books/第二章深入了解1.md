### 第2章 深入了解GPT-4和ChatGPT的API

本章详细介绍GPT-4和ChatGPT的API，帮助你掌握这些API的使用方法，以便有效地将它们集成到Python应用程序中。学完本章后，你将能够熟练地使用这些API，并在自己的开发项目中充分利用它们的强大功能。

首先，我们了解OpenAI Playground。这将使你在编写代码之前更好地了解模型。接着，我们学习OpenAI Python库。这部分内容包括登录信息和一个简单的Hello World示例。然后，我们学习创建和发送API请求的过程，并了解如何处理API响应。这将确保你知道如何解释这些API返回的数据。最后，本章还会介绍诸如安全最佳实践和成本管理等考虑因素。

随着学习的深入，你将获得实用的知识，这对使用GPT-4和ChatGPT进行Python开发非常有帮助。你可以在随书文件包¹中找到本章涉及的所有Python代码。

注1：请访问图灵社区，免费下载随书文件包：ituring.cn/book/3344。——编者注

在继续阅读之前，请查看OpenAI的使用规则。如果还没有账户，请在OpenAI主页上创建一个。你也可以查看OpenAI and Policies页面上的内容。第1章介绍的概念对于使用OpenAI API及其相关库是必需的。

### 2.1 基本概念

OpenAI提供了多个专为不同任务设计的模型，每个模型都有自己的定价。接下来，我们将详细地对比这些模型并讨论如何根据需求选择模型。需要注意的是，模型的设计目的——无论是用于补全文本、聊天还是编辑——会影响你如何使用其API。比如，GPT-4和ChatGPT背后的模型基于聊天目的，并使用聊天端点。

第1章介绍了“提示词”这个概念。提示词不仅适用于OpenAI API，而且是所有LLM的入口点。简单地说，提示词就是用户发送给模型的输入文本，用于指导模型执行特定任务。对于GPT-4和ChatGPT背后的模型，提示词具有聊天格式，输入消息和输出消息存储在列表中。本章将详细探讨提示词的格式。

除了提示词，第1章还介绍了标记。标记是词或词的一部分。据粗略估计，100个标记大约相当于75个英语单词。对OpenAI模型的请求是根据所使用的标记数量来定价的，也就是说，调用API的成本取决于输入文本和输出文本的长度。有关管理和控制输入标记数量和输出标记数量的更多详细信息，请参阅2.5节和2.6节。

图2-1总结了OpenAI API的基本概念。

| 提示词 | 标记 | 模型 | 标记 | 文本补全 |
| ---- | ---- | ---- | ---- | ---- |
|  |  |  |  |  |

图2-1：OpenAI API的基本概念

了解基本概念之后，让我们深入探讨模型的细节。

### 2.2 OpenAI API提供的可用模型

通过OpenAI API，你可以使用OpenAI开发的多个模型。这些模型可通过API作为服务使用（通过直接的HTTP调用或提供的库），这意味着OpenAI在远程服务器上运行模型，开发人员只需向其发送查询请求即可。

每个模型都有自己的功能和定价。本节将介绍OpenAI通过其API提供的LLM。需要注意的是，这些模型是专有的，你不能根据自己的需求直接修改模型的代码。但是正如后文所述，你可以通过OpenAI API在特定数据上微调其中的一些模型。

一些较旧的OpenAI模型（包括GPT-2模型）并不是专有的。你可以直接从Hugging Face或GitHub下载GPT-2模型，但无法通过API使用它。

由于OpenAI提供的许多模型会不断更新，因此本书很难给出完整的列表。要了解最新的模型列表，请查看OpenAI的在线文档。本章将重点介绍以下几个最为重要的模型。

#### InstructGPT
这个模型系列可以处理许多单轮文本补全任务。text-ada-001模型只能处理简单的文本补全任务，但它也是GPT-3系列中速度最快、价格最便宜的模型。text-babbage-001模型和text-curie-001模型稍微强大一些，但也更昂贵。text-davinci-003模型可以出色地执行所有文本补全任务，但它也是GPT-3系列²中最昂贵的。

#### ChatGPT
ChatGPT背后的模型是gpt-3.5-turbo。作为一个聊天模型，它可以将一系列消息作为输入，并生成相应的消息作为输出。虽然gpt-3.5-turbo的聊天格式旨在进行多轮对话，但它也可用于没有对话的单轮任务。在单轮任务中，gpt-3.5-turbo的性能与text-davinci-003相当。由于gpt-3.5-turbo的价格只有text-davinci-003的十分之一³，而且两者性能相当，因此建议默认使用它来进行单轮任务。gpt-3.5-turbo模型的上下文窗口大小约为4000个标记，这意味着它可以接收约4000个标记作为输入。OpenAI还提供了另一个模型，名为gpt-3.5-turbo-16k。它具有与标准的gpt-3.5-turbo模型相同的功能，但上下文窗口大小是后者的4倍。

#### GPT-4
这是迄今为止OpenAI发布的最大的模型。由于在广泛的文本和图像多模态语料库上进行了训练，因此它精通许多领域。GPT-4能够准确地遵循复杂的自然语言指令并解决难题。它可用于聊天任务和单轮任务，并具有相当高的准确性。OpenAI提供了两个GPT-4模型⁴：gpt-4的上下文窗口大小为8192个标记，gpt-4-32k的上下文窗口大小为32768个标记。32768个标记大约相当于24576个英语单词，即大约40页的上下文。

无论是GPT-3.5 Turbo还是GPT-4，都在持续更新。当提到gpt-3.5-turbo、gpt-3.5-turbo-16k、gpt-4和gpt-4-32k时，我们指的是这些模型的最新版本⁵。开发人员通常希望LLM版本具有良好的稳定性和可见性，以便在应用程序中使用它。对于开发人员来说，如果模型的版本在一夜之间发生变化，并且针对相同的输入给出截然不同的回答，那么这样的模型使用起来很困难。为此，OpenAI提供了这些模型的静态快照版本。在我们撰写本书之时，上述模型最新的静态快照版本分别是gpt-3.5-turbo-0613、gpt-3.5-turbo-16k-0613、gpt-4-0613和gpt-4-32k-0613。

正如第1章所述，OpenAI建议使用InstructGPT系列而不是原始的GPT3模型。这些模型仍然在API中以davinci、curie、babbage和ada的名称提供。鉴于这些模型可能给出奇怪、错误和具有误导性的回答，我们建议在使用时要谨慎。然而，由于这些模型是仅有的几个可以针对你的数据进行微调的模型，因此它们仍然可用。截至本书英文版出版之时，OpenAI已宣布将于2024年提供GPT-3.5 Turbo和GPT-4的微调功能。⁶

第1章介绍的SFT模型在经过SFT阶段后获得，该模型没有经过RLHF阶段，也可以通过API以davinci-instruct-beta的名称使用。

注2：截至2023年11月下旬的消息，InstructGPT系列将在2024年1月4日统一替换为最新的gpt-3.5-turbo-instruct模型。——译者注

注3：截至2023年11月下旬，最新版本的text-davinci-003价格是每个千标记0.0200美元，gpt-3.5-turbo-0613的价格是每千个输入标记0.0030美元 + 每千个输出标记0.004美元。——译者注

注4：截至2023年11月下旬，OpenAI已提供6个GPT-4模型，包括gpt-4-1106-preview、gpt-4-vision-preview、gpt-4、gpt-4-32k、gpt-4-0613、gpt-4-32k-0613。——译者注

注5：截至2023年11月下旬，文中提到的模型版本已更新至gpt-3.5-turbo-1106、gpt-3.5-turbo-0613、gpt-4-1106-preview、gpt-4-32k-0613。——译者注

注6：截至2023年11月下旬，GPT-3.5微调功能已完全开放，GPT-4微调功能可通过申请权限开放。——译者注

### 2.3 在OpenAI Playground中使用GPT模型

OpenAI Playground是一个基于Web的平台。你可以使用它直接测试OpenAI提供的语言模型，而无须编写代码。

在OpenAI Playground上，你可以编写提示词，选择模型，并轻松查看模型生成的输出。要测试OpenAI提供的各种LLM在特定任务上的表现，OpenAI Playground是绝佳的途径。

以下是访问OpenAI Playground的步骤。

1. 访问OpenAI主页，然后依次单击Developers → Overview。

2. 如果你已经拥有一个账户但未登录，请单击屏幕右上方的Log in。如果还没有OpenAI账户，那么你需要创建账户才能使用Playground和OpenAI的大部分功能。请注意，由于Playground和API是收费的，因此你在注册账户时需要提供支付方式。 

3. 登录后，你将在网页的顶部看到加入Playground的链接。单击该链接，你应该会看到图2-2所示的内容。

ChatGPT Plus选项与使用API或Playground无关。如果你是ChatGPT Plus用户，那么仍需要支付费用才能使用API和Playground。 

![image](https://github.com/user-attachments/assets/3819c418-7c7e-4af0-85de-2aa26cbe8432)


图2-2：OpenAI Playground补全模式下的界面⁷

界面中的主要空白处用于输入消息。编写完消息后，单击Submit按钮以生成输出。在图2-2所示的示例中，我们编写消息“As Descartes said, I think therefore”（正如笛卡尔所说，我思故），然后单击Submit按钮。模型用“I am”（我在）补全了文本。

注7：OpenAI Playground在2023年11月7日的OpenAI首届开发者大会后已更新版本，最新版本的界面与图2-2中的界面存在差异，请以最新版本为准。——译者注

每次单击Submit按钮时，OpenAI都会收取相应的费用。本章稍后会提供有关费用的更多信息。就本例而言，成本约为0.0002美元。

界面的底部和右侧有许多选项。我们从底部开始。在Submit按钮右侧的是撤销按钮（在图中标记为A），用于删除最后生成的文本。在本例中，它将删除“I am”。接下来是重新生成按钮（在图中标记为B），用于重新生成刚刚删除的文本。再往后是历史按钮（在图中标记为C），它会给出过去30天内的所有请求。请注意，一旦进入历史菜单，你就可以出于隐私原因轻松地删除请求。

右侧的选项面板提供与界面和所选模型相关的各种设置。我们在此只解释其中的一些选项，后文会陆续介绍其他选项。右侧的第一个下拉列表是模式列表（在图中标记为D）。在我们撰写本书之时，可用的模式有聊天（默认选项）、补全和编辑。

补全模式和编辑模式已被标记为遗留模式，可能会在2024年1月消失。

如前所示，语言模型在Playground的补全模式下努力补全用户的输入。





图2-3展示了在聊天模式下使用Playground的示例。界面左侧是系统面板（在图中标记为E）。在这里，你可以描述聊天系统的行为方式。比如，在图2-3中，我们要求它成为一个喜欢猫的有用助手。我们还要求它只谈论猫，并给出简短的回答。根据设置的这些参数所生成的对话显示在界面中央。

如果想继续与系统对话，你可以单击Add message（在图中标记为F），输入消息，然后单击Submit按钮（在图中标记为G）。还可以在右侧定义模型（在图中标记为H），这里使用GPT-4。请注意，并非所有模型在所有模式下都可用。比如，只有GPT-4和GPT-3.5 Turbo在聊天模式下可用⁸。

注8：截至2023年11月下旬，OpenAI Playground聊天模式可用的模型包括gpt-3.5-turbo、gpt-3.5-turbo-0301、gpt-3.5-turbo-0613、gpt-3.5-turbo-1106、gpt-3.5-turbo-16k、gpt-3.5-turbo-16k-0613。——译者注

![image](https://github.com/user-attachments/assets/51f7c38a-b147-41d5-ba32-8c4a13f92082)

图2-3：OpenAI Playground聊天模式下的界面

Playground还提供了编辑模式。如图2-4所示，在这种模式下，你提供一些文本（在图中标记为I）和指令（在图中标记为J），模型将尝试修改文本。在图2-4所示的例子中，我们给出了一段描述一个年轻男子要去旅行的文本。同时，我们指示模型将文本中的主人公更改为一位年长的女士。可以看到，结果（在图中标记为K）符合指令。

![image](https://github.com/user-attachments/assets/cf954fe8-928b-4245-8bf8-bec0d997ad2c)


图2-4：OpenAI Playground编辑模式下的界面

在Playground界面的右侧、模式下拉列表下方的是模型下拉列表（在图中标记为L）。正如你已经看到的，这是你选择LLM的地方。该下拉列表中可用的模型取决于所选的模式。在模型下拉列表下方的是参数，例如温度（在图中标记为M），它定义模型的行为。我们不会在此详细讨论这些参数。在详细讨论不同模型的工作原理时，我们会探索这里的大部分参数。

界面顶部有一个加载预设项的下拉列表（在图中标记为N）和4个按钮。在图2-2中，我们使用LLM来补全句子，但是通过使用适当的提示词，我们也可以让模型执行特定的任务。图2-5显示了模型可以执行的常见任务。

![image](https://github.com/user-attachments/assets/a7a74be5-5a20-4d40-b561-812bac224683)


图2-5：模型可以执行的常见任务

应注意，预设项不仅定义了提示词，还定义了界面右侧的一些选项。如果选择“Grammatical Standard English”（语法标准的英语），那么你将在主窗口中看到图2-6所示的提示词。

![image](https://github.com/user-attachments/assets/b09c6719-f599-42c4-8a4b-4822054daac3)


图2-6：预设项Grammatical Standard English的提示词示例

如果单击Submit按钮，那么你将得到以下结果：“She did not go to the market”（她没有去市场）。虽然可以从下拉列表中的提示词入手，但是你应该修改它们以使其适合你的问题。OpenAI为不同的任务提供了完整的示例列表，详见OpenAI网站的Examples页面。

在图2-4中的“Load a preset”下拉列表旁边的是Save按钮（在图中标记为O）。想象一下，你已经为任务定义了有价值的提示词，也选择了模型及其参数，并且希望以后在Playground中轻松复用它们。Save按钮的功能是把Playground的当前状态保存为一个预设状态。你可以为预设状态命名并添加描述信息。一旦保存，你的预设状态就将出现在“Load a preset”下拉列表中。

Save按钮右侧的是View code按钮（在图中标记为P）。它提供了在Playground中直接运行测试代码的脚本。你可以请求Python、Node.js或cURL代码，以便在Linux终端中直接与OpenAI远程服务器交互。如果用Python代码给出提示词“As Descartes said, I think therefore”，那么我们将得到以下结果：

```python
import openai
openai.api_key = os.getenv("OPENAI_API_KEY")
response = openai.Completion.create(
    model="text-davinci-003",
    prompt="As Descartes said, I think therefore",
    temperature=0.7,
    max_tokens=3,
    top_p=1,
    frequency_penalty=0,
    presence_penalty=0,
)
```
现在你应该了解了如何在没有编码的情况下使用Playground来测试OpenAI的语言模型。接下来，让我们讨论如何获取和管理OpenAI服务的API密钥。

### 2.4 开始使用OpenAI Python库

本节重点介绍如何在一个小型Python脚本中使用API密钥，并展示如何使用OpenAI API进行第一次测试。

OpenAI将GPT-4和ChatGPT作为服务提供。这意味着用户无法直接访问 
